name: Release Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release'
        required: true
        default: 'v1.0.0'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js for npm pack
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Get version from tag
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag_name }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        # Remove 'v' prefix if present
        VERSION=${VERSION#v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "TAG_NAME=${{ github.event.inputs.tag_name || github.ref_name }}" >> $GITHUB_OUTPUT
    
    - name: Update package.json version
      run: |
        cd Assets/uMcp
        # Update version in package.json
        jq --arg version "${{ steps.get_version.outputs.VERSION }}" '.version = $version' package.json > package.json.tmp
        mv package.json.tmp package.json
        
    - name: Create package archive
      run: |
        # Create the standard package tgz for Assets folder (backward compatibility)
        tar -czf com.umcp.unity-mcp-server-${{ steps.get_version.outputs.VERSION }}.tgz -C Assets uMcp/
        
        # Create UPM package using npm pack (Unity recommended method)
        cd Assets/uMcp
        echo "Files in source package:"
        ls -la
        
        # Verify package.json exists and is valid
        if [ -f package.json ]; then
            echo "package.json found and verified:"
            cat package.json | head -10
            
            # Use npm pack to create Unity-compatible tgz
            echo "Creating UPM package with npm pack..."
            npm pack --pack-destination ../..
            
            # List created files
            cd ../..
            echo "npm pack created files:"
            ls -la *.tgz
            
            # Rename npm pack output to expected filename
            NPM_PACK_FILE=$(ls com.yoshi32a.unity-mcp-server-*.tgz 2>/dev/null | head -1 || echo "")
            if [ -n "$NPM_PACK_FILE" ]; then
                mv "$NPM_PACK_FILE" "com.umcp.unity-mcp-server-${{ steps.get_version.outputs.VERSION }}-upm.tgz"
                echo "Renamed $NPM_PACK_FILE to com.umcp.unity-mcp-server-${{ steps.get_version.outputs.VERSION }}-upm.tgz"
            else
                echo "ERROR: npm pack failed to create tgz file!"
                exit 1
            fi
            
            # Debug: Check the structure of created tgz
            echo "Checking UPM package structure:"
            tar -tzf com.umcp.unity-mcp-server-${{ steps.get_version.outputs.VERSION }}-upm.tgz | head -20
        else
            echo "ERROR: package.json not found!"
            exit 1
        fi
        
    - name: Extract changelog entry
      id: changelog
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        CHANGELOG_FILE="Assets/uMcp/CHANGELOG.md"
        
        # Extract the specific version changelog entry
        if [ -f "$CHANGELOG_FILE" ]; then
          # Get content between version headers
          awk -v version="$VERSION" '
            /^## \[/ { 
              if (found) exit
              if ($0 ~ "\\[" version "\\]") { found=1; next }
              next
            }
            found && /^## \[/ { exit }
            found { print }
          ' "$CHANGELOG_FILE" > version_changelog.md
          
          # Check if we found content
          if [ -s version_changelog.md ]; then
            echo "Found changelog entry for v$VERSION"
          else
            echo "No specific changelog entry found for v$VERSION, using generic content"
            echo "è©³ç´°ãªå¤‰æ›´å†…å®¹ã«ã¤ã„ã¦ã¯ [CHANGELOG.md](Assets/uMcp/CHANGELOG.md) ã‚’ã”è¦§ãã ã•ã„ã€‚" > version_changelog.md
          fi
        else
          echo "CHANGELOG.md not found"
          echo "è©³ç´°ãªå¤‰æ›´å†…å®¹ã«ã¤ã„ã¦ã¯ [CHANGELOG.md](Assets/uMcp/CHANGELOG.md) ã‚’ã”è¦§ãã ã•ã„ã€‚" > version_changelog.md
        fi

    - name: Generate release notes
      id: release_notes
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
        
        cat << EOF > release_notes.md
        # Unity MCP Server v$VERSION
        
        $(cat version_changelog.md)
        
        ## ğŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
        
        ### æ–¹æ³•1: æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        1. \`com.umcp.unity-mcp-server-$VERSION.tgz\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        2. Unity ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® \`Assets\` ãƒ•ã‚©ãƒ«ãƒ€ã«å±•é–‹
        
        ### æ–¹æ³•2: Unity Package Manager (ãƒ­ãƒ¼ã‚«ãƒ«)
        1. \`com.umcp.unity-mcp-server-$VERSION-upm.tgz\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        2. Unity ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® \`Packages\` ãƒ•ã‚©ãƒ«ãƒ€ã«å±•é–‹
        
        ### æ–¹æ³•3: Unity Package Manager (ç›´æ¥)
        1. \`com.umcp.unity-mcp-server-$VERSION-upm.tgz\` ã‚’ä»»æ„ã®å ´æ‰€ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        2. Unity ã§Package Manager ã‚’é–‹ã
        3. "+" â†’ "Add package from tarball..." ã‚’ã‚¯ãƒªãƒƒã‚¯
        4. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸ .tgz ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
        
        ### æ–¹æ³•4: Git URLï¼ˆæ¨å¥¨ï¼‰
        Package Manager ã§ä»¥ä¸‹ã®URLã‚’è¿½åŠ :
        \`\`\`
        https://github.com/${{ github.repository }}.git?path=Assets/uMcp#$TAG_NAME
        \`\`\`
        
        ## ğŸ“‹ å‹•ä½œè¦ä»¶
        - Unity 2022.3 LTS ä»¥é™
        - UniTask 2.3.3 ä»¥é™
        
        ## ğŸš€ ä¸»è¦æ©Ÿèƒ½
        - **25å€‹ã®ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«**: Unityæƒ…å ±ã€ã‚¢ã‚»ãƒƒãƒˆç®¡ç†ã€ãƒ“ãƒ«ãƒ‰ç®¡ç†ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œç´¢ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€ã‚¨ãƒ‡ã‚£ã‚¿æ‹¡å¼µ
        - **Markdownãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚·ã‚¹ãƒ†ãƒ **: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œã®ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ãƒˆãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ
        - **ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼çµ±åˆ**: è‡ªå‹•èµ·å‹•æ©Ÿèƒ½ä»˜ãã®ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãªUnity Editorçµ±åˆ
        - **éåŒæœŸã‚µãƒãƒ¼ãƒˆ**: ãƒãƒ³ãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°æ“ä½œã®ãŸã‚ã®å®Œå…¨ãªUniTaskçµ±åˆ
        
        ## ğŸ› ï¸ ä½¿ç”¨é–‹å§‹æ–¹æ³•
        1. ä¸Šè¨˜ã®ã„ãšã‚Œã‹ã®æ–¹æ³•ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        2. Unity Editor ã‚’é–‹ã
        3. \`Tools > uMCP > Create Default Tool Assets\` ã«ç§»å‹•
        4. MCPã‚µãƒ¼ãƒãƒ¼ãŒ \`http://localhost:49001/umcp/\` ã§è‡ªå‹•é–‹å§‹
        
        ## ğŸ“– è©³ç´°æƒ…å ±
        - [å®Œå…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://github.com/${{ github.repository }}/blob/$TAG_NAME/Assets/uMcp/README.md)
        - [å¤‰æ›´å±¥æ­´](https://github.com/${{ github.repository }}/blob/$TAG_NAME/Assets/uMcp/CHANGELOG.md)
        EOF
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.TAG_NAME }}
        name: Unity MCP Server v${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          com.umcp.unity-mcp-server-${{ steps.get_version.outputs.VERSION }}.tgz
          com.umcp.unity-mcp-server-${{ steps.get_version.outputs.VERSION }}-upm.tgz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}